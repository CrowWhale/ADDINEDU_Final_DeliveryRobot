<img src="https://capsule-render.vercel.app/api?type=waving&color=auto&height=200&section=header&text=Realsense/YOLOv7&fontSize=90"/>


# <div align="center">ìš”ì•½ì •ë¦¬</div>

## <div align="center">  ğŸ¦­ ì†Œê°œ ğŸ¦­ </div>

<span style="font-size: 10px;"> ì‹¤ë‚´ ë°°ì†¡ ë¡œë´‡ ì„œë¹„ìŠ¤ì—ì„œ ë¡œë´‡íŒ”ë¡œ ì—¬ëŸ¬ í–‰ìœ„ë¥¼ í•˜ê¸° ìœ„í•´ì„œëŠ” ì •í™•í•œ ìœ„ì¹˜ë¥¼ íŒŒì•…í•˜ëŠ” ê²ƒì´ í•„ìˆ˜ì ì´ë‹¤. ë•Œë¬¸ì—, ì ˆëŒ€ ì¢Œí‘œê³„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•œ, ë²„íŠ¼ì˜ (x,y,z) ì¢Œí‘œë¥¼ ì¶”ì¶œí•˜ëŠ” ê²ƒê³¼ ì—˜ë¦¬ë² ì´í„° ë¬¸ê³¼ì˜ ê±°ë¦¬ ì¸¡ì •ì„ ë°”íƒ•ìœ¼ë¡œ ì—´ê³  ë‹«ì•˜ìŒì„ ì•Œ ìˆ˜ ìˆë„ë¡ RealSense D435 ëª¨ë¸ê³¼ Yolov7ì„ í™œìš©í•˜ì—¬ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ì˜€ë‹¤. </span>

## <div align="center"> ğŸ¦„ ê¸°ìˆ  ìŠ¤íƒ ğŸ¦„ </div>

<div align="center">
	<img src="https://img.shields.io/badge/python-3776AB?style=flat&logo=python&logoColor=white" />
	<img src="https://img.shields.io/badge/mysql-4479A1?style=flat&logo=mysql&logoColor=white" />
	<img src="https://img.shields.io/badge/HTML5-E34F26?style=flat&logo=HTML5&logoColor=white" />
	<img src="https://img.shields.io/badge/visual studio code-007ACC?style=flat&logo=visualstudiocode&logoColor=white" />
	<img src="https://img.shields.io/badge/C++-00599C?style=flat-square&logo=C%2B%2B&logoColor=white"/>
 	<img src="https://img.shields.io/badge/Docker-2496ED?style=flat-square&logo=Docker&logoColor=white"/>
  	<img src="https://img.shields.io/badge/GitHub-181717?style=flat-square&logo=GitHub&logoColor=white"/>
   	<img src="https://img.shields.io/badge/Ubuntu-E95420?style=flat-square&logo=Ubuntu&logoColor=white"/>
</div>

## <div align="center"> ğŸ” í”„ë¡œê·¸ë¨ ì‹¤í–‰ ğŸ” </div>
### (1)
![ezgif com-video-to-gif](https://github.com/addinedu-ros-2nd/robot-repo-1/assets/47076138/eb679b0a-1f5f-4909-b294-be70ccbb02f6)
### (2)
![ezgif com-video-to-gif (1)](https://github.com/addinedu-ros-2nd/robot-repo-1/assets/47076138/6f97749c-2506-4979-95c4-7861764e332c)



### ì¹´ë©”ë¼ ê¸°ì¤€ ê°ì²´ ì¢Œí‘œê³„ ì¶”ì¶œ

## <div align="center"> ğŸ­ ì£¼ìš” ê¸°ëŠ¥ ğŸ­ </div>

- ì¹´ë©”ë¼ ê¸°ì¤€ ì ˆëŒ€ ì¢Œí‘œê³„ì—ì„œ ì¸ì‹í•œ ê°ì²´ì˜ ì¢Œí‘œë¥¼ ì¶”ì¶œí•˜ì—¬ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥í•˜ëŠ” ëª…ë ¹ì–´

```
python3 detect_RS.py --weights yolov7.pt --conf-thres 0.2

```
![image](https://github.com/addinedu-ros-2nd/robot-repo-1/assets/47076138/f43497bb-643e-4a73-9224-b77bd7972e11)

- ì—˜ë¦¬ë² ì´í„°ê¹Œì§€ì˜ ê±°ë¦¬ê°’ì„ ì¸ì‹í•˜ì—¬ 0.3m ì´ìƒì¼ ê²½ìš° ì—˜ë¦¬ë² ì´í„° ë¬¸ì´ ì—´ë¦¼, 0.3m ì´í•˜ì¼ ê²½ìš° ì—˜ë¦¬ë² ì´í„° ë¬¸ì´ ë‹«í˜ìœ¼ë¡œ ì¸ì‹í•˜ëŠ” ëª…ë ¹ì–´
  
```
python3 depth_el.py
```
![ezgif com-video-to-gif (1)](https://github.com/addinedu-ros-2nd/robot-repo-1/assets/47076138/8f41da90-46bc-4bc0-a9a1-62c78b1b427c)


# 1. RealSense SDK(ê¸°ì´ˆ ë§¤ë‰´ì–¼ )


## (1) íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ:
- ì„œë²„ì˜ ê³µê°œ í‚¤ ë“±ë¡:
```
sudo mkdir -p /etc/apt/keyrings
curl -sSf https://librealsense.intel.com/Debian/librealsense.pgp | sudo tee /etc/apt/keyrings/librealsense.pgp > /dev/null
```

`sudo apt-get install apt-transport-https`

- ì €ì¥ì†Œ ëª©ë¡ì— ì„œë²„ë¥¼ ì¶”ê°€: 
```
echo "deb [signed-by=/etc/apt/keyrings/librealsense.pgp] https://librealsense.intel.com/Debian/apt-repo `lsb_release -cs` main" | \
sudo tee /etc/apt/sources.list.d/librealsense.list
sudo apt-get update
```

- ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜: 
  `sudo apt-get install librealsense2-dkms`  
  `sudo apt-get install librealsense2-utils`  
ìœ„ì˜ ë‘ ì¤„ì€ librealsense2 udev ê·œì¹™ì„ ë°°í¬í•˜ê³  ì»¤ë„ ëª¨ë“ˆ, ëŸ°íƒ€ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬, ì‹¤í–‰ ê°€ëŠ¥í•œ ë°ëª¨ ë° ë„êµ¬ë¥¼ ë¹Œë“œ ë° í™œì„±í™”í•©ë‹ˆë‹¤.


- ì„ íƒì ìœ¼ë¡œ ê°œë°œì ë° ë””ë²„ê·¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜: 
  `sudo apt-get install librealsense2-dev`  
  `sudo apt-get install librealsense2-dbg`  

Intel RealSense D435 ì¹´ë©”ë¼ë¥¼ ë‹¤ì‹œ ì—°ê²°í•˜ê³  ë‹¤ìŒì„ ì‹¤í–‰: `realsense-viewer`

ì»¤ë„ ì—…ë°ì´íŠ¸ í™•ì¸ :    
`modinfo uvcvideo | grep "version:"` ëŠ” `realsense` ë¥¼ í¬í•¨í•´ì•¼ í•œë‹¤.





## (2) íŒ¨í‚¤ì§€ ì—…ê·¸ë ˆì´ë“œ:
ë‹¤ìŒì„ í˜¸ì¶œí•˜ì—¬ ë¡œì»¬ íŒ¨í‚¤ì§€ ìºì‹œë¥¼ ìƒˆë¡œ ê³ ì¹©ë‹ˆë‹¤.
  `sudo apt-get update`  

`librealsense` í¬í•¨í•˜ì—¬ ì„¤ì¹˜ëœ ëª¨ë“  íŒ¨í‚¤ì§€ë¥¼ ì—…ê·¸ë ˆì´ë“œí•©ë‹ˆë‹¤.
  `sudo apt-get upgrade`

ì„ íƒí•œ íŒ¨í‚¤ì§€ë¥¼ ì—…ê·¸ë ˆì´ë“œí•˜ë ¤ë©´ ë³´ë‹¤ ì„¸ë¶€ì ì¸ ì ‘ê·¼ ë°©ì‹ë§Œ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  `sudo apt-get --only-upgrade install <package1 package2 ...>`  
  ì˜ˆì‹œ:   
  `sudo apt-get --only-upgrade install  librealsense2-utils librealsense2-dkms`  

## (3) íŒ¨í‚¤ì§€ ì œê±°:
**Important**  íŒ¨í‚¤ì§€ ì œê±°ëŠ” ì„¤ì¹˜ëœ ë‹¤ë¥¸ íŒ¨í‚¤ì§€ê°€ ì´ë¥¼ ì§ì ‘ ì°¸ì¡°í•˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ë§Œ í—ˆìš©ëœë‹¤.
ì˜ˆë¥¼ ë“¤ì–´,`librealsense2-udev-rules`ë¥¼ ì‚­ì œ í•˜ê¸° ìœ„í•´ì„œëŠ” `librealsense2` ë¥¼ ë¨¼ì € ì§€ìš¸ ê²ƒ.

ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ ë‹¨ì¼ íŒ¨í‚¤ì§€ë¥¼ ì œê±°
  `sudo apt-get purge <package-name>`  

ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ RealSenseâ„¢ SDK ê´€ë ¨ íŒ¨í‚¤ì§€ë¥¼ ëª¨ë‘ ì œê±°
  `dpkg -l | grep "realsense" | cut -d " " -f 3 | xargs sudo dpkg --purge`  

## íŒ¨í‚¤ì§€ ì„¸ë¶€ì‚¬í•­:

ì´ë¦„    |      ì½˜í…ì¸    | Depends on |
-------- | ------------ | ---------------- |
librealsense2-udev-rules | ì»¤ë„ ìˆ˜ì¤€ì—ì„œ RealSense ì¥ì¹˜ ê¶Œí•œì„ êµ¬ì„±í•©ë‹ˆë‹¤.	 | -
librealsense2-dkms | ì‹¬ë„ ì¹´ë©”ë¼ë³„ ì»¤ë„ í™•ì¥ìš© DKMS íŒ¨í‚¤ì§€ | librealsense2-udev-rules
librealsense2 | RealSenseâ„¢ SDK ëŸ°íƒ€ì„(.so) ë° êµ¬ì„± íŒŒì¼ | librealsense2-udev-rules
librealsense2-utils | RealSenseâ„¢ SDKì˜ ì¼ë¶€ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ë°ëª¨ ë° ë„êµ¬	 | librealsense2
librealsense2-dev | ê°œë°œìë¥¼ ìœ„í•œ í—¤ë” íŒŒì¼ ë° ì‹¬ë³¼ë¦­ ë§í¬ | librealsense2
librealsense2-dbg | ê°œë°œìë¥¼ ìœ„í•œ ë””ë²„ê·¸ ê¸°í˜¸  | librealsense2
librealsense2-gl | GLSL í™•ì¥ ëª¨ë“ˆ ëŸ°íƒ€ì„ ë° êµ¬ì„± íŒŒì¼ | librealsense2
librealsense2-gl-dev | GLSL ê°œë°œ í—¤ë” íŒŒì¼ ë° ì‹¬ë³¼ë¦­ ë§í¬ | librealsense2
librealsense2-gl-dbg | ë””ë²„ê¹… ëª©ì ì— í•„ìš”í•œ GLSL ë””ë²„ê·¸ ê¸°í˜¸ | librealsense2

<br><br><br><br>


# 2. Official YOLOv7(ê¸°ì´ˆ ë§¤ë‰´ì–¼)

## (1)ì„±ëŠ¥

MS COCO

| Model | í…ŒìŠ¤íŠ¸ Size | AP<sup>í…ŒìŠ¤íŠ¸</sup> | AP<sub>50</sub><sup>í…ŒìŠ¤íŠ¸</sup> | AP<sub>75</sub><sup>í…ŒìŠ¤íŠ¸</sup> | ë°°ì¹˜ 1 fps | ë°°ì¹˜ 32 average time |
| :-- | :-: | :-: | :-: | :-: | :-: | :-: |
| [**YOLOv7**](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7.pt) | 640 | **51.4%** | **69.7%** | **55.9%** | 161 *fps* | 2.8 *ms* |
| [**YOLOv7-X**](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7x.pt) | 640 | **53.1%** | **71.2%** | **57.8%** | 114 *fps* | 4.3 *ms* |
|  |  |  |  |  |  |  |
| [**YOLOv7-W6**](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-w6.pt) | 1280 | **54.9%** | **72.6%** | **60.1%** | 84 *fps* | 7.6 *ms* |
| [**YOLOv7-E6**](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-e6.pt) | 1280 | **56.0%** | **73.5%** | **61.2%** | 56 *fps* | 12.3 *ms* |
| [**YOLOv7-D6**](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-d6.pt) | 1280 | **56.6%** | **74.0%** | **61.8%** | 44 *fps* | 15.0 *ms* |
| [**YOLOv7-E6E**](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-e6e.pt) | 1280 | **56.8%** | **74.4%** | **62.1%** | 36 *fps* | 18.7 *ms* |

## (2)ì„¤ì¹˜

ë„ì»¤ í™˜ê²½ (ì¶”ì²œ)
<details><summary> <b>ë”ë³´ê¸°</b> </summary>

``` shell
# create the docker container, you can change the share memory size if you have more.
nvidia-docker run --name yolov7 -it -v your_coco_path/:/coco/ -v your_code_path/:/yolov7 --shm-size=64g nvcr.io/nvidia/pytorch:21.08-py3

# apt install required packages
apt update
apt install -y zip htop screen libgl1-mesa-glx

# pip install required packages
pip install seaborn thop

# go to code folder
cd /yolov7
```

</details>

## (3) í…ŒìŠ¤íŠ¸

[`yolov7.pt`](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7.pt) [`yolov7x.pt`](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7x.pt) [`yolov7-w6.pt`](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-w6.pt) [`yolov7-e6.pt`](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-e6.pt) [`yolov7-d6.pt`](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-d6.pt) [`yolov7-e6e.pt`](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-e6e.pt)

``` shell
python test.py --data data/coco.yaml --img 640 --batch 32 --conf 0.001 --iou 0.65 --device 0 --weights yolov7.pt --name yolov7_640_val
```

## (4) í›ˆë ¨

ë°ì´í„° ì¤€ë¹„í•˜ê¸°
``` shell
bash scripts/get_coco.sh
```

'ë‹¨ì¼' GPU í›ˆë ¨
``` shell
# train p5 models
python train.py --workers 8 --device 0 --batch-size 32 --data data/coco.yaml --img 640 640 --cfg cfg/training/yolov7.yaml --weights '' --name yolov7 --hyp data/hyp.scratch.p5.yaml

# train p6 models
python train_aux.py --workers 8 --device 0 --batch-size 16 --data data/coco.yaml --img 1280 1280 --cfg cfg/training/yolov7-w6.yaml --weights '' --name yolov7-w6 --hyp data/hyp.scratch.p6.yaml
```

ë‹¤ì¤‘ GPU í›ˆë ¨
``` shell
# train p5 models
python -m torch.distributed.launch --nproc_per_node 4 --master_port 9527 train.py --workers 8 --device 0,1,2,3 --sync-bn --batch-size 128 --data data/coco.yaml --img 640 640 --cfg cfg/training/yolov7.yaml --weights '' --name yolov7 --hyp data/hyp.scratch.p5.yaml

# train p6 models
python -m torch.distributed.launch --nproc_per_node 8 --master_port 9527 train_aux.py --workers 8 --device 0,1,2,3,4,5,6,7 --sync-bn --batch-size 128 --data data/coco.yaml --img 1280 1280 --cfg cfg/training/yolov7-w6.yaml --weights '' --name yolov7-w6 --hyp data/hyp.scratch.p6.yaml
```

## (5) ì „ì´ í•™ìŠµ

[`yolov7_training.pt`](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7_training.pt) [`yolov7x_training.pt`](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7x_training.pt) [`yolov7-w6_training.pt`](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-w6_training.pt) [`yolov7-e6_training.pt`](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-e6_training.pt) [`yolov7-d6_training.pt`](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-d6_training.pt) [`yolov7-e6e_training.pt`](https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-e6e_training.pt)

ë§ì¶¤í˜• ë°ì´í„° ì„¸íŠ¸ë¥¼ ìœ„í•œ ë‹¨ì¼ GPU ë¯¸ì„¸ ì¡°ì •
``` shell
# finetune p5 models
python train.py --workers 8 --device 0 --batch-size 32 --data data/custom.yaml --img 640 640 --cfg cfg/training/yolov7-custom.yaml --weights 'yolov7_training.pt' --name yolov7-custom --hyp data/hyp.scratch.custom.yaml

# finetune p6 models
python train_aux.py --workers 8 --device 0 --batch-size 16 --data data/custom.yaml --img 1280 1280 --cfg cfg/training/yolov7-w6-custom.yaml --weights 'yolov7-w6_training.pt' --name yolov7-w6-custom --hyp data/hyp.scratch.custom.yaml
```

## (6) ì¶”ë¡ í•´ë³´ê¸°

ë¹„ë””ì˜¤ :
``` shell
python detect.py --weights yolov7.pt --conf 0.25 --img-size 640 --source yourvideo.mp4
```

ì´ë¯¸ì§€ :
``` shell
python detect.py --weights yolov7.pt --conf 0.25 --img-size 640 --source inference/images/horses.jpg
```

![image](https://github.com/addinedu-ros-2nd/robot-repo-1/assets/47076138/811e1317-de4e-4b8e-97e3-ef6e7227cccc)



<br><br><br><br>

# 3. YOLOv7 í•™ìŠµëœ ë°ì´í„°ì™€ RealSense D435ë¥¼ í™œìš©í•œ ì¢Œí‘œ ì¶”ì¶œ
## (1) 

detect_RS.py ì½”ë“œ ì¤‘ ì¼ë¶€...
```
--- ìƒëµ ---
        if key == ord('p'):
            # 'p' í‚¤ë¥¼ ëˆŒë €ì„ ë•Œì˜ ë™ì‘
            with open("pixel_data.txt", "w") as file:
                for label, (depth_point_in_color[0], depth_point_in_color[1], depth_point_in_color[2]) in depth_info.items():
                    file.write(f'{label}: {depth_point_in_color[0]:.5f},{depth_point_in_color[1]:.5f},{depth_point_in_color[2]:.5f}\n')
        if key == ord('q'):
            break
--- ì´í•˜ ìƒëµ ---
```
í•´ë‹¹ ì½”ë“œë¥¼ ë°”íƒ•ìœ¼ë¡œ, ê°ì²´ ì¸ì‹ëœ ê°ê°ì˜ ìš”ì†Œì˜ x,y,z ì¢Œí‘œë¥¼ pixel_data.txt í…ìŠ¤íŠ¸ íŒŒì¼ì— ì €ì¥í•œë‹¤.

ëª…ë ¹ì–´
```
python3 detect_RS.py --weights [í•™ìŠµëª¨ë¸] --conf-thres [ì›í•˜ëŠ” í™•ë¥ ]
```
ì˜ˆì‹œ)
```
python3 detect_RS.py --weights best.pt --conf-thres 0.5
```

# 4. Realsense D435ë¥¼ í™œìš©í•œ ì •ë©´ ë¬¼ì²´ì™€ì˜ ê±°ë¦¬ ì¸¡ì •

depth_el.py ì½”ë“œ ì¤‘ ì¼ë¶€...
```
--- ìƒëµ ---
                x, y = 320, 240
                depth_el = round(depth_frame.get_distance(x, y), 2)
                print("ì—˜ë¦¬ë² ì´í„°ì™€ì˜ ê±°ë¦¬: ", depth_el, "m")
â€‹
                if depth_el >= 0.3 :
                    print("ì—˜ë¦¬ë² ì´í„° ì—´ë¦¼")
                    self.toggle = 1  # ê±°ë¦¬ê°€ 30 ì´ìƒì´ë©´ toggleì— 1 ì €ì¥
                else:
                    # print("ì—˜ë¦¬ë² ì´í„° ë‹«í˜")
                    self.toggle = 0  # ê±°ë¦¬ê°€ 30 ë¯¸ë§Œì´ë©´ toggleì— 0 ì €ì¥
â€‹
                color_image = np.asanyarray(aligned_frames.get_color_frame().get_data())
                cv2.imshow('RealSense', cv2.circle(color_image, (x, y), 2, (0, 0, 255), -1))
--- ì´í•˜ ìƒëµ ---
```
í•´ë‹¹ ì½”ë“œë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì •ë©´ ë¬¼ì²´ì™€ì˜ ê±°ë¦¬ë¥¼ ì¸¡ì •í•˜ì—¬, 0.3m ì´ìƒì´ë©´ ì—˜ë¦¬ë² ì´í„° ì—´ë¦¼, 0.3mì´í•˜ì´ë©´ ì—˜ë¦¬ë² ì´í„° ë‹«í˜ìœ¼ë¡œ ì¸ì‹í•œë‹¤.

ëª…ë ¹ì–´
```
python3 depth_el.py
```
